version: "{branch}-{build}"

max_jobs: 1

branches:
  only:
    - master
    - /test|alpha|beta/
    - /^\d+\.\d+(\.\d+)?$/
    - /^v?\d+\.\d+\.\d+(-[a-zA-Z0-9\.]+)?$/ # Because it applies to tags as well

environment:
 PY_PYTHON: 3.7-32

init:
  - ps: |
      Set-AppveyorBuildVariable -name "description" -value $(APPVEYOR_REPO_TAG_NAME) -replace '^.*[^\d]' # Strips leading "v" etc. off of version numbers for descriptions
      if ($env:APPVEYOR_REPO_TAG_NAME) {
        if ($env:APPVEYOR_REPO_TAG_NAME -match '-dev|-alpha|-beta') {
          Set-AppveyorBuildVariable -Name "prerelease" -Value "tru"
          Add-AppveyorMessage -Message "This is a pre-release build." -category Information
        } else {
          Set-AppveyorBuildVariable -Name "prerelease" -Value "false"
          Add-AppveyorMessage -Message "This is not a pre-release build." -category Information
        }
      }
  - echo Pre-release is set to $(prerelease)

install:
  - set path=%path%;C:\Python37\Scripts
  - py -m pip install markdown
  - py -m pip install scons

build_script:
  - set path=%path%;C:\Python37\Scripts
  - scons
  - scons pot

artifacts:
  - path: '*.nvda-addon'
    name: addon
    type: application/x-nvda-addon
  - path: '*.pot'
    type: application/x-pot
    
deploy:
  release: $(APPVEYOR_REPO_TAG_NAME)
  description: "Version $(description)"
  provider: GitHub
  auth_token:
    secure: ayZmtkNXgFmwTjA6LMI7/cCcFVAL9w7IiKuCOFeegjntytcAOY8Wzb2LAX2ZqKgY
  artifact: addon
  draft: false
  prerelease: $(prerelease)
  on:
    appveyor_repo_tag: true        # deploy on tag push only
    
#deploy:
#  release: $(APPVEYOR_REPO_TAG_NAME)
#  description: $(APPVEYOR_REPO_TAG_NAME)
#  provider: GitHub
#  auth_token:
#    secure: ayZmtkNXgFmwTjA6LMI7/cCcFVAL9w7IiKuCOFeegjntytcAOY8Wzb2LAX2ZqKgY
#  artifact: addon
#  draft: false
#  prerelease: $(prerelease)
#  on:
#    appveyor_repo_tag: true        # deploy on tag push only
#    branch: /stable/

notifications:
  - provider: Email
    to:
      - '{{build_commitAuthorEmail}}'
    on_build_success: true
    on_build_failure: true
    on_build_status_changed: true
